name: Create Issue on New submissions

permissions:
  issues: write
  contents: write

on:
  push:
    paths:
      - "submissions/pictures/**"

jobs:
  create-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure directories exist
        run: |
          mkdir -p submissions/pictures
          mkdir -p submissions/json
          touch submissions/pictures/.gitkeep
          touch submissions/json/.gitkeep

      - name: Find changed images
        id: diff
        uses: tj-actions/changed-files@v45
        with:
          files: submissions/pictures/**

      - name: Create Issues
        if: steps.diff.outputs.all_changed_files != ''
        run: |
          for file in ${{ steps.diff.outputs.all_changed_files }}; do
            filename=$(basename "$file")
            base="${filename%.*}"
            json_path="submissions/json/$base.json"

            if [[ ! -f "$json_path" ]]; then
              echo "No json for $filename, skip"
              continue
            fi

            json=$(cat "$json_path")

            # æå–å­—æ®µ
            name=$(jq -r '.name' <<< "$json")
            class=$(jq -r '.class' <<< "$json")
            type=$(jq -r '.type' <<< "$json")
            sentence=$(jq -r '.sentence // ""' <<< "$json")
            authorized=$(jq -r '.authorized' <<< "$json")

            if [[ "$authorized" == "true" ]]; then
              auth_text="æ˜¯ï¼ˆå·²è·å¾—è‚–åƒæƒæˆæƒï¼‰"
            else
              auth_text="å¦"
            fi

            # ---- ç”Ÿæˆä¸´æ—¶ Markdown æ–‡ä»¶ ----
            tmpfile=$(mktemp)

            echo "### ğŸ“¸ æ–°æŠ•ç¨¿ï¼š$base" >> "$tmpfile"
            echo "" >> "$tmpfile"
            echo "**æŠ•ç¨¿è€…å§“åï¼š** $name  " >> "$tmpfile"
            echo "**æŠ•ç¨¿è€…ç­çº§ï¼š** $class  " >> "$tmpfile"
            echo "**ä½œå“ç±»å‹ï¼š** $type  " >> "$tmpfile"
            echo "**ä¸€å¥è¯ï¼š** ${sentence:-æ— }  " >> "$tmpfile"
            echo "**äººåƒæˆæƒï¼š** $auth_text  " >> "$tmpfile"
            echo "" >> "$tmpfile"
            echo "---" >> "$tmpfile"
            echo "" >> "$tmpfile"
            echo "### ğŸ–¼ï¸ ä½œå“é¢„è§ˆ" >> "$tmpfile"
            echo "![å›¾ç‰‡é¢„è§ˆ](./$file)" >> "$tmpfile"
            echo "" >> "$tmpfile"
            echo "---" >> "$tmpfile"
            echo "" >> "$tmpfile"
            echo "### ğŸ“„ JSON åŸå§‹æ•°æ®" >> "$tmpfile"
            echo "\`\`\`json" >> "$tmpfile"
            echo "$json" >> "$tmpfile"
            echo "\`\`\`" >> "$tmpfile"

            # ---- ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶åˆ›å»º Issue ----
            gh issue create \
              --title "æ–°æŠ•ç¨¿ï¼š$base" \
              --body-file "$tmpfile"

            # ---- åˆ é™¤ä¸´æ—¶æ–‡ä»¶ ----
            rm "$tmpfile"

          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
