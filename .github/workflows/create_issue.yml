name: Create Issue on New submissions

permissions:
  issues: write
  contents: write

on:
  push:
    paths:
      - "submissions/picturess/**"

jobs:
  create-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure directories exist
        run: |
          mkdir -p submissions/picturess
          mkdir -p submissions/json
          touch submissions/picturess/.gitkeep
          touch submissions/json/.gitkeep

      - name: Find changed images
        id: diff
        uses: tj-actions/changed-files@v45
        with:
          files: submissions/picturess/**

      - name: Create Issues
        if: steps.diff.outputs.all_changed_files != ''
        run: |
          repo="bbezStuUnion/OmniaFrame"
          branch="main"

          for file in ${{ steps.diff.outputs.all_changed_files }}; do
            filename=$(basename "$file")
            base="${filename%.*}"
            json_path="submissions/json/$base.json"

            if [[ ! -f "$json_path" ]]; then
              echo "No json for $filename, skip."
              continue
            fi

            json=$(cat "$json_path")

            name=$(jq -r '.name' <<< "$json")
            class=$(jq -r '.class' <<< "$json")
            type=$(jq -r '.type' <<< "$json")
            sentence=$(jq -r '.sentence // ""' <<< "$json")
            authorized=$(jq -r '.authorized' <<< "$json")

            if [[ "$authorized" == "true" ]]; then
              auth_text="æ˜¯ï¼ˆå·²èŽ·å¾—è‚–åƒæƒæŽˆæƒï¼‰"
            else
              auth_text="å¦"
            fi

            # æž„é€  RAW å›¾ç‰‡ç›´é“¾
            raw_url="https://raw.githubusercontent.com/$repo/refs/heads/$branch/$file"

            # ---- ä¸´æ—¶ Markdown æ–‡ä»¶ ----
            tmpfile=$(mktemp)

            echo "### ðŸ“¸ æ–°æŠ•ç¨¿ï¼š$base" >> "$tmpfile"
            echo "" >> "$tmpfile"
            echo "**æŠ•ç¨¿è€…å§“åï¼š** $name  " >> "$tmpfile"
            echo "**æŠ•ç¨¿è€…ç­çº§ï¼š** $class  " >> "$tmpfile"
            echo "**ä½œå“ç±»åž‹ï¼š** $type  " >> "$tmpfile"
            echo "**ä¸€å¥è¯ï¼š** ${sentence:-æ— }  " >> "$tmpfile"
            echo "**äººåƒæŽˆæƒï¼š** $auth_text  " >> "$tmpfile"
            echo "" >> "$tmpfile"
            echo "---" >> "$tmpfile"
            echo "" >> "$tmpfile"
            echo "### ðŸ–¼ï¸ ä½œå“é¢„è§ˆ" >> "$tmpfile"
            echo "![ä½œå“å›¾ç‰‡]($raw_url)" >> "$tmpfile"
            echo "" >> "$tmpfile"
            echo "---" >> "$tmpfile"
            echo "" >> "$tmpfile"
            echo "### ðŸ“„ JSON åŽŸå§‹æ•°æ®" >> "$tmpfile"
            echo "\`\`\`json" >> "$tmpfile"
            echo "$json" >> "$tmpfile"
            echo "\`\`\`" >> "$tmpfile"

            gh issue create \
              --title "æ–°æŠ•ç¨¿ï¼š$base" \
              --body-file "$tmpfile"

            rm "$tmpfile"

          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
