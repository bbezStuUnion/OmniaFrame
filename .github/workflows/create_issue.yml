name: Create Issue on New pictures

permissions:
  issues: write
  contents: write

on:
  push:
    paths:
      - "submissions/pictures/**"   # ä»…å›¾ç‰‡ç›®å½•å˜åŠ¨è§¦å‘

jobs:
  create-issue:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Ensure directories exist
        run: |
          mkdir -p submissions/pictures
          mkdir -p submissions/json
          touch submissions/pictures/.gitkeep
          touch submissions/json/.gitkeep

      - name: Detect *added* images only
        id: diff
        uses: tj-actions/changed-files@v45
        with:
          files: submissions/pictures/**
          json: true

      - name: Output debug info
        run: |
          echo "Added files: ${{ steps.diff.outputs.added_files }}"

      - name: Create Issue for each new image
        if: steps.diff.outputs.added_files != ''
        run: |
          for file in ${{ steps.diff.outputs.added_files }}; do
            image=$(basename "$file")
            base="${image%.*}"
            json_path="submissions/json/$base.json"

            echo "æ–°å›¾ç‰‡ï¼š$image"

            if [[ ! -f "$json_path" ]]; then
              echo "âš  æ‰¾ä¸åˆ°å¯¹åº” JSONï¼š$json_pathï¼Œè·³è¿‡"
              continue
            fi

            # è§£æ JSON
            title=$(jq -r '.æ ‡é¢˜ // "æœªå¡«å†™"' "$json_path")
            name=$(jq -r '.æäº¤è€…å§“å // "æœªå¡«å†™"' "$json_path")
            class=$(jq -r '.æäº¤è€…ç­çº§ // "æœªå¡«å†™"' "$json_path")
            type=$(jq -r '.ä½œå“ç±»å‹ // "æœªå¡«å†™"' "$json_path")
            sentence=$(jq -r '.ä¸€å¥è¯ // "æ— "' "$json_path")
            authorized=$(jq -r '.è‚–åƒæˆæƒ // "å¦"' "$json_path")

            # Markdown å†…å®¹ï¼ˆå«å›¾ç‰‡ï¼‰
            body_md=$(cat <<EOF
              ### ğŸ“¸ æ–°æŠ•ç¨¿ï¼š$base

              #### ğŸ–¼ï¸ å›¾ç‰‡é¢„è§ˆ
              ![é¢„è§ˆå›¾]($file)

              ---

               ğŸ“ æŠ•ç¨¿ä¿¡æ¯
              - **æ ‡é¢˜**ï¼š$title  
              - **æäº¤è€…**ï¼š$name  
              - **ç­çº§**ï¼š$class  
              - **ä½œå“ç±»å‹**ï¼š$type  
              - **ä¸€å¥è¯**ï¼š$sentence  
              - **è‚–åƒæˆæƒ**ï¼š$authorized  

              ---

              ### ğŸ“„ JSON åŸæ–‡
              \`\`\`json
              $(cat "$json_path")
              \`\`\`
            EOF
            )

            gh issue create \
              --title "æ–°æŠ•ç¨¿ï¼š$base" \
              --body "$body_md"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
