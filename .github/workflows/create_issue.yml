name: Create Issue on New submissions

permissions:
  issues: write
  contents: write

on:
  push:
    paths:
      - "submissions/pictures/**"

jobs:
  create-issue:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Ensure directories exist
        run: |
          mkdir -p submissions/pictures
          mkdir -p submissions/json
          touch submissions/pictures/.gitkeep
          touch submissions/json/.gitkeep

      - name: Find changed images
        id: diff
        uses: tj-actions/changed-files@v45
        with:
          files: submissions/pictures/**

      - name: Process submissions
        if: steps.diff.outputs.all_changed_files != ''
        run: |
          for file in ${{ steps.diff.outputs.all_changed_files }}; do
            image=$(basename "$file")
            base="${image%.*}"
            json_path="submissions/json/$base.json"

            if [[ ! -f "$json_path" ]]; then
              echo "No json for $image, skip"
              continue
            fi

            body=$(cat "$json_path")

            gh issue create \
              --title "新投稿：$base" \
              --body "投稿内容：\n\`\`\`json\n$body\n\`\`\`\n文件：$file"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
