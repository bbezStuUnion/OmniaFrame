name: Create Issue on New Submission

on:
  push:
    paths:
      - "submission/pictures/**"

jobs:
  create-issue:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Ensure directories exist
        run: |
          mkdir -p submission/picture
          mkdir -p submission/json
          touch submission/picture/.gitkeep
          touch submission/json/.gitkeep

      - name: Find changed images
        id: diff
        uses: tj-actions/changed-files@v45
        with:
          files: submission/picture/**

      - name: Process submissions
        if: steps.diff.outputs.all_changed_files != ''
        run: |
          for file in ${{ steps.diff.outputs.all_changed_files }}; do
            image=$(basename "$file")
            base="${image%.*}"
            json_path="submission/json/$base.json"

            if [[ ! -f "$json_path" ]]; then
              echo "No json for $image, skip"
              continue
            fi

            body=$(cat "$json_path")

            gh issue create \
              --title "新投稿：$base" \
              --body "投稿内容：\n\`\`\`json\n$body\n\`\`\`\n文件：$file"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
