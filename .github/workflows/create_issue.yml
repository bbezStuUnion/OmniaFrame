name: Create Issue on New pictures

permissions:
  issues: write
  contents: write

on:
  push:
    paths:
      - "submissions/pictures/**"   # ä»…å›¾ç‰‡ç›®å½•å˜åŠ¨è§¦å‘

jobs:
  create-issue:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Ensure directories exist
        run: |
          mkdir -p submissions/pictures
          mkdir -p submissions/json
          touch submissions/pictures/.gitkeep
          touch submissions/json/.gitkeep

      - name: Detect *added* images only
        id: diff
        uses: tj-actions/changed-files@v45
        with:
          files: submissions/pictures/**
          json: true

      - name: Output debug info
        run: |
          echo "Added files: ${{ steps.diff.outputs.added_files }}"

      - name: Create Issue for each new image
        if: steps.diff.outputs.added_files != ''
        run: |
          for file in ${{ steps.diff.outputs.added_files }}; do

            image=$(basename "$file")
            base="${image%.*}"
            json_path="submissions/json/$base.json"

            if [[ ! -f "$json_path" ]]; then
              echo "âš  æ‰¾ä¸åˆ° JSONï¼š$json_path"
              continue
            fi

            # è¯»å– JSON å­—æ®µ
            title=$(jq -r '.æ ‡é¢˜ // "æœªå¡«å†™"' "$json_path")
            name=$(jq -r '.æäº¤è€…å§“å // "æœªå¡«å†™"' "$json_path")
            class=$(jq -r '.æäº¤è€…ç­çº§ // "æœªå¡«å†™"' "$json_path")
            type=$(jq -r '.ä½œå“ç±»åž‹ // "æœªå¡«å†™"' "$json_path")
            sentence=$(jq -r '.ä¸€å¥è¯ // "æ— "' "$json_path")
            authorized=$(jq -r '.è‚–åƒæŽˆæƒ // "å¦"' "$json_path")

            # ç”Ÿæˆä¸´æ—¶æ­£æ–‡æ–‡ä»¶ï¼ˆè‡ªåŠ¨åˆ é™¤ï¼‰
            body_file="$(mktemp)"
            {
              echo "### ðŸ“¸ æ–°æŠ•ç¨¿ï¼š$base"
              echo
              echo "#### ðŸ–¼ï¸ å›¾ç‰‡é¢„è§ˆ"
              echo "![é¢„è§ˆå›¾]($file)"
              echo
              echo "---"
              echo
              echo "### ðŸ“ æŠ•ç¨¿ä¿¡æ¯"
              echo "- **æ ‡é¢˜**ï¼š$title"
              echo "- **æäº¤è€…**ï¼š$name"
              echo "- **ç­çº§**ï¼š$class"
              echo "- **ä½œå“ç±»åž‹**ï¼š$type"
              echo "- **ä¸€å¥è¯**ï¼š$sentence"
              echo "- **è‚–åƒæŽˆæƒ**ï¼š$authorized"
              echo
              echo "---"
              echo
              echo "### ðŸ“„ JSON åŽŸæ–‡"
              echo '```json'
              cat "$json_path"
              echo '```'
            } > "$body_file"

            # åˆ›å»º Issue
            gh issue create \
              --title "æ–°æŠ•ç¨¿ï¼š$base" \
              --body-file "$body_file"

            rm "$body_file"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
